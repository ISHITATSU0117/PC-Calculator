<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSVè§£æã‚¢ãƒ—ãƒª - ç®¡ç†ç”»é¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
            text-align: center;
        }

        .subtitle {
            color: #666;
            margin-bottom: 40px;
            font-size: 16px;
            text-align: center;
        }

        .nav-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .nav-section h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .nav-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
        }

        .nav-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            transform: translateY(-3px);
        }

        .nav-card .icon {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .nav-card h3 {
            font-size: 18px;
            color: #333;
            margin-bottom: 8px;
        }

        .nav-card p {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        .control-panel {
            background: #fff8e1;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .control-panel h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: white;
            border-radius: 6px;
        }

        .auto-refresh input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .auto-refresh label {
            cursor: pointer;
            font-size: 15px;
            color: #333;
        }

        .config-section {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .config-section h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
        }

        .config-section h2:hover {
            color: #1976d2;
        }

        .toggle-icon {
            transition: transform 0.3s ease;
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .config-form {
            display: grid;
            gap: 15px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }

        .config-form.collapsed {
            max-height: 0 !important;
            opacity: 0;
            margin-top: 0;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-size: 14px;
            color: #555;
            font-weight: 500;
        }

        .form-group input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ CSVè§£æã‚¢ãƒ—ãƒª - ç®¡ç†ç”»é¢</h1>
        <p class="subtitle">é€šéæ™‚é–“è¨ˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ ã®ç®¡ç†ã¨è¨­å®š</p>

        <!-- è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="config-section">
            <h2 onclick="toggleConfigSection()">
                <span>âš™ï¸ GitHubè¨­å®š</span>
                <span class="toggle-icon collapsed" id="toggleIcon">â–¼</span>
            </h2>
            <div class="config-form collapsed" id="configForm">
                <div class="form-group">
                    <label>GitHubãƒ¦ãƒ¼ã‚¶ãƒ¼å/çµ„ç¹”å</label>
                    <input type="text" id="githubOwner" placeholder="ä¾‹: username">
                </div>
                <div class="form-group">
                    <label>ãƒªãƒã‚¸ãƒˆãƒªå</label>
                    <input type="text" id="githubRepo" placeholder="ä¾‹: csv-data">
                </div>
                <div class="form-group">
                    <label>ãƒ–ãƒ©ãƒ³ãƒå</label>
                    <input type="text" id="githubBranch" placeholder="ä¾‹: main" value="main">
                </div>
                <div class="form-group">
                    <label>CSVãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª</label>
                    <input type="text" id="csvDirectory" placeholder="ä¾‹: csv" value="csv">
                </div>
                <div class="form-group">
                    <label>Personal Access Tokenï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»å‰Šé™¤ã«å¿…è¦ï¼‰</label>
                    <input type="password" id="githubToken" placeholder="ghp_...">
                </div>
                <button onclick="saveConfig()">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
            </div>
            <div id="configStatus"></div>
        </div>

        <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="nav-section">
            <h2>ğŸ“‘ ãƒšãƒ¼ã‚¸</h2>
            <div class="nav-grid">
                <a href="results.html" class="nav-card">
                    <div class="icon">ğŸ“Š</div>
                    <h3>çµæœå…¬é–‹ãƒšãƒ¼ã‚¸</h3>
                    <p>è¨ˆç®—çµæœã‚’è¡¨ç¤º<br>ï¼ˆä¸€èˆ¬å…¬é–‹ç”¨ï¼‰</p>
                </a>
                <a href="upload.html" class="nav-card">
                    <div class="icon">ğŸ“¤</div>
                    <h3>ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                    <p>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’<br>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
                </a>
                <a href="manage.html" class="nav-card">
                    <div class="icon">ğŸ“</div>
                    <h3>ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†</h3>
                    <p>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®<br>ç¢ºèªãƒ»å‰Šé™¤</p>
                </a>
            </div>
        </div>

        <!-- è¨ˆç®—åˆ¶å¾¡ -->
        <div class="control-panel">
            <h2>ğŸ”„ è¨ˆç®—åˆ¶å¾¡</h2>
            <div class="control-buttons">
                <button onclick="executeCalculation()">æ‰‹å‹•è¨ˆç®—å®Ÿè¡Œ</button>
                <div class="auto-refresh">
                    <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
                    <label for="autoRefresh">è‡ªå‹•è¨ˆç®—ï¼ˆ2åˆ†ã”ã¨ï¼‰</label>
                </div>
            </div>
            <div id="calcStatus"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="api.js"></script>
    <script src="calculator.js"></script>
    <script>
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadConfigToForm();
            checkAutoRefreshStatus();
            initializeConfigSection();
        });

        // è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ï¼ˆæœ€åˆã¯æŠ˜ã‚ŠãŸãŸã‚€ï¼‰
        function initializeConfigSection() {
            const configForm = document.getElementById('configForm');
            const toggleIcon = document.getElementById('toggleIcon');
            // åˆæœŸçŠ¶æ…‹ã¯æŠ˜ã‚ŠãŸãŸã¾ã‚Œã¦ã„ã‚‹
            configForm.classList.add('collapsed');
            toggleIcon.classList.add('collapsed');
        }

        // è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿
        function toggleConfigSection() {
            const configForm = document.getElementById('configForm');
            const toggleIcon = document.getElementById('toggleIcon');
            
            if (configForm.classList.contains('collapsed')) {
                // å±•é–‹ã™ã‚‹ - ã¾ãšé«˜ã•ã‚’è¨ˆç®—ã—ã¦ã‹ã‚‰è¨­å®š
                const height = configForm.scrollHeight;
                configForm.style.maxHeight = height + 'px';
                configForm.classList.remove('collapsed');
                toggleIcon.classList.remove('collapsed');
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«maxHeightã‚’å‰Šé™¤ï¼ˆå‹•çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¯¾å¿œï¼‰
                setTimeout(() => {
                    if (!configForm.classList.contains('collapsed')) {
                        configForm.style.maxHeight = 'none';
                    }
                }, 300);
            } else {
                // æŠ˜ã‚ŠãŸãŸã‚€ - ã¾ãšç¾åœ¨ã®é«˜ã•ã‚’è¨­å®šã—ã¦ã‹ã‚‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                configForm.style.maxHeight = configForm.scrollHeight + 'px';
                // å¼·åˆ¶çš„ã«ãƒªãƒ•ãƒ­ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã‚‹
                configForm.offsetHeight;
                configForm.style.maxHeight = '0';
                configForm.classList.add('collapsed');
                toggleIcon.classList.add('collapsed');
            }
        }

        // è¨­å®šã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«èª­ã¿è¾¼ã‚€
        function loadConfigToForm() {
            const config = ConfigManager.load();
            document.getElementById('githubOwner').value = config.owner || '';
            document.getElementById('githubRepo').value = config.repo || '';
            document.getElementById('githubBranch').value = config.branch || 'main';
            document.getElementById('csvDirectory').value = config.csvDir || 'csv';
            document.getElementById('githubToken').value = config.token || '';
        }

        // è¨­å®šã‚’ä¿å­˜
        function saveConfig() {
            const config = {
                owner: document.getElementById('githubOwner').value.trim(),
                repo: document.getElementById('githubRepo').value.trim(),
                branch: document.getElementById('githubBranch').value.trim() || 'main',
                csvDir: document.getElementById('csvDirectory').value.trim() || 'csv',
                token: document.getElementById('githubToken').value.trim()
            };

            if (!config.owner || !config.repo) {
                showStatus('configStatus', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒªãƒã‚¸ãƒˆãƒªåã¯å¿…é ˆã§ã™', 'error');
                return;
            }

            ConfigManager.save(config);
            showStatus('configStatus', 'è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        }

        // æ‰‹å‹•è¨ˆç®—å®Ÿè¡Œ
        async function executeCalculation() {
            if (!ConfigManager.isConfigured()) {
                showStatus('calcStatus', 'GitHubè¨­å®šã‚’å®Œäº†ã—ã¦ãã ã•ã„', 'warning');
                return;
            }

            showStatus('calcStatus', 'è¨ˆç®—ã‚’å®Ÿè¡Œä¸­...', 'info');

            const result = await Calculator.calculate();

            if (result.success) {
                let message = `è¨ˆç®—å®Œäº†: ${result.fileCount}ãƒ•ã‚¡ã‚¤ãƒ«ã€${result.bibData.length}ã‚¼ãƒƒã‚±ãƒ³`;
                let statusType = 'success';
                let hasErrors = false;
                
                // åŒºé–“é‡è¤‡ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆ
                if (result.overlaps && result.overlaps.length > 0) {
                    statusType = 'error';
                    hasErrors = true;
                    message = 'âš ï¸ ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«åã§åŒºé–“ã®é‡è¤‡ãŒã‚ã‚Šã¾ã™\n\n';
                    result.overlaps.forEach(overlap => {
                        message += `â€¢ ${overlap.file1} ã¨ ${overlap.file2} ã§ ${overlap.section}${overlap.type} ãŒé‡è¤‡ã—ã¦ã„ã¾ã™\n`;
                    });
                    message += '\né‡è¤‡ã—ã¦ã„ã‚‹åŒºé–“ã®æ™‚åˆ»ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚\nåŒã˜åŒºé–“ã®åŒã˜ã‚¿ã‚¤ãƒ—ï¼ˆSTART/GOALï¼‰ã¯1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã®ã¿å«ã‚ã¦ãã ã•ã„ã€‚';
                }
                
                // ã‚¼ãƒƒã‚±ãƒ³ç•ªå·é‡è¤‡ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆ
                if (result.bibNumberDuplicates && result.bibNumberDuplicates.length > 0) {
                    statusType = 'error';
                    if (hasErrors) {
                        message += '\n\n';
                    } else {
                        message = '';
                    }
                    message += 'âš ï¸ ã‚¨ãƒ©ãƒ¼: åŒã˜åŒºé–“ã§åŒã˜ã‚¼ãƒƒã‚±ãƒ³ç•ªå·ãŒè¤‡æ•°å›å‡ºç¾ã—ã¦ã„ã¾ã™\n\n';
                    result.bibNumberDuplicates.forEach(dup => {
                        message += `â€¢ ã‚¼ãƒƒã‚±ãƒ³ ${dup.bibNumber} ãŒ ${dup.section}${dup.type} ã§è¤‡æ•°å›å‡ºç¾: ${dup.files.join(', ')}\n`;
                    });
                    message += '\né‡è¤‡ã—ã¦ã„ã‚‹ã‚¼ãƒƒã‚±ãƒ³ã®æ™‚åˆ»ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚';
                }
                
                // ã‚¨ãƒ©ãƒ¼ãŒãªã„å ´åˆã¯æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                if (!hasErrors && (!result.bibNumberDuplicates || result.bibNumberDuplicates.length === 0)) {
                    message = `è¨ˆç®—å®Œäº†: ${result.fileCount}ãƒ•ã‚¡ã‚¤ãƒ«ã€${result.bibData.length}ã‚¼ãƒƒã‚±ãƒ³`;
                }
                
                showStatus('calcStatus', message, statusType);
            } else {
                showStatus('calcStatus', `ã‚¨ãƒ©ãƒ¼: ${result.error}`, 'error');
            }
        }

        // è‡ªå‹•æ›´æ–°ã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            if (checkbox.checked) {
                localStorage.setItem('autoRefreshEnabled', 'true');
                startAutoRefresh();
                showStatus('calcStatus', 'è‡ªå‹•è¨ˆç®—ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼ˆ2åˆ†ã”ã¨ï¼‰', 'success');
            } else {
                localStorage.setItem('autoRefreshEnabled', 'false');
                stopAutoRefresh();
                showStatus('calcStatus', 'è‡ªå‹•è¨ˆç®—ã‚’åœæ­¢ã—ã¾ã—ãŸ', 'info');
            }
        }

        // è‡ªå‹•æ›´æ–°ã‚’é–‹å§‹
        let autoRefreshInterval = null;
        function startAutoRefresh() {
            if (autoRefreshInterval) return;
            
            autoRefreshInterval = setInterval(async () => {
                await executeCalculation();
            }, CONFIG.AUTO_REFRESH_INTERVAL);
        }

        // è‡ªå‹•æ›´æ–°ã‚’åœæ­¢
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // è‡ªå‹•æ›´æ–°ã®çŠ¶æ…‹ã‚’ç¢ºèª
        function checkAutoRefreshStatus() {
            const enabled = localStorage.getItem('autoRefreshEnabled') === 'true';
            document.getElementById('autoRefresh').checked = enabled;
            if (enabled && ConfigManager.isConfigured()) {
                startAutoRefresh();
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showStatus(elementId, message, type) {
            const statusDiv = document.getElementById(elementId);
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
    </script>
</body>
</html>
