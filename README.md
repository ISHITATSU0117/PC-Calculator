# CSV解析アプリ - 通過時間計測

ゼッケン番号ごとの区間通過時間を計算・表示するWebアプリケーションです。
GitHubリポジトリをストレージとして使用し、複数ページで構成された管理システムを提供します。

## 📋 主な機能

- **GitHub連携**: GitHubリポジトリをCSVファイルストレージとして使用
- **ファイルアップロード**: WebブラウザからGitHubへ直接CSVファイルをアップロード
- **ファイル管理**: アップロード済みファイルの確認・削除
- **自動計算**: GitHubのCSVファイルを定期的に監視して自動計算（2分ごと）
- **結果公開**: 計算結果を一般公開用ページで表示
- **マルチページ構成**: 管理・公開・アップロード・ファイル管理の4ページ構成

## 🏗️ ページ構成

### 1. 管理画面（index.html）
- **GitHub設定**: リポジトリ情報とPersonal Access Tokenの設定
- **ページリンク**: 各ページへのナビゲーション
- **計算制御**: 手動計算実行と自動計算の切り替え

### 2. 結果公開ページ（results.html）
- **結果表示**: 計算結果を表形式で表示
- **最終更新時刻**: 最後に計算を実行した時刻を表示
- **一般公開用**: 他のページへのリンクなし

### 3. ファイルアップロードページ（upload.html）
- **CSVアップロード**: ドラッグ&ドロップまたはファイル選択
- **複数ファイル対応**: 一度に複数のCSVファイルをアップロード
- **命名規則確認**: 正しいファイル名形式の確認

### 4. ファイル管理ページ（manage.html）
- **ファイル一覧**: アップロード済みCSVファイルの確認
- **アップロード時刻**: 各ファイルのアップロード日時を表示
- **削除機能**: 不要なファイルの削除（単一・一括）
- **ダウンロード**: ファイルのローカル保存

## 🚀 セットアップ手順

### 1. GitHubリポジトリの準備

#### データ保存用リポジトリを作成
```bash
# 新しいリポジトリを作成（例: csv-data）
# Public または Private を選択
# csvディレクトリを作成（空のまま）
```

#### Personal Access Token（PAT）を作成
1. GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic)
2. "Generate new token (classic)" をクリック
3. スコープで以下を選択:
   - `repo` (Full control of private repositories)
4. トークンを生成してコピー（後で使用）

### 2. アプリをGitHub Pagesで公開

#### アプリ用リポジトリを作成
```bash
# 新しいリポジトリを作成（例: csv-analyzer）
# Public を選択
```

#### ファイルをアップロード
以下のファイルをリポジトリにアップロード:
- `index.html`
- `results.html`
- `upload.html`
- `manage.html`
- `config.js`
- `api.js`
- `calculator.js`

#### GitHub Pagesを有効化
1. リポジトリの Settings → Pages
2. Source: "Deploy from a branch"
3. Branch: "main" / フォルダ: "/ (root)"
4. Save

数分後、公開URLが表示されます（例: `https://username.github.io/csv-analyzer/`）

### 3. アプリの初期設定

1. **管理画面にアクセス**
   - `https://username.github.io/csv-analyzer/` を開く

2. **GitHub設定を入力**
   - **GitHubユーザー名**: あなたのGitHubユーザー名
   - **リポジトリ名**: データ保存用リポジトリ名（例: `csv-data`）
   - **ブランチ名**: `main`
   - **CSVディレクトリ**: `csv`
   - **Personal Access Token**: 作成したトークン

3. **設定を保存**
   - 「設定を保存」ボタンをクリック

### 4. CSVファイルのアップロード

1. **アップロードページにアクセス**
   - 管理画面から「ファイルアップロード」をクリック

2. **CSVファイルを選択**
   - ドラッグ&ドロップ または クリックして選択
   - 複数ファイルを同時選択可能

3. **アップロード実行**
   - 「アップロード開始」ボタンをクリック

### 5. 計算と結果表示

1. **手動計算**
   - 管理画面で「手動計算実行」ボタンをクリック

2. **自動計算を有効化**
   - 「自動計算（2分ごと）」のチェックボックスをON

3. **結果を確認**
   - 「結果公開ページ」をクリック
   - または直接 `https://username.github.io/csv-analyzer/results.html` にアクセス

## 📁 CSVファイル形式

### ファイル構造

CSVファイルは以下の4列で構成されます：

```csv
measurer,type,time,number
device1,auto,14:23:00.63,101
device1,auto,14:23:15.42,102
```

- **measurer**: 計測機器名
- **type**: 計測タイプ
- **time**: 通過時刻（HH:MM:SS.ms形式）
- **number**: ゼッケン番号（空欄の場合は通過なし）

### ファイル名規則

ファイル名で区間を指定します：

- **単体形式**: `PC1START.csv`, `PC1GOAL.csv`
  - PC1のSTART地点
  - PC1のGOAL地点

- **複合形式**: `PC1GOAL_PC2START.csv`
  - PC1のGOAL地点かつPC2のSTART地点
  - "_"で複数の区間を連結

### 例

```
PC1START.csv         → PC1のスタート
PC1GOAL_PC2START.csv → PC1のゴール＆PC2のスタート
PC2GOAL.csv          → PC2のゴール
CO1START.csv         → CO1のスタート
CO1GOAL.csv          → CO1のゴール
```

## 🧮 計算方法

1. **通過時刻の抽出**
   - CSV内でnumber（ゼッケン番号）が入力されている行の時刻を抽出

2. **区間の対応付け**
   - ファイル名からSTART/GOAL地点を判定
   - 同じ区間（PC1、PC2など）のSTARTとGOALをペアにする

3. **通過時間の計算**
   - 通過時間（秒）＝ GOAL時刻 − START時刻
   - 小数点以下2桁まで表示

4. **表示**
   - ゼッケン番号を縦軸
   - 区間（PC1、PC2、CO1など）を横軸
   - 各セルに START時刻、GOAL時刻、通過時間を表示

## 📦 サンプルデータ

`sample-csv/` ディレクトリにサンプルCSVファイルが含まれています：

- `PC1START.csv` - PC1スタート地点の通過記録
- `PC1GOAL_PC2START.csv` - PC1ゴール＆PC2スタート地点
- `PC2GOAL.csv` - PC2ゴール地点
- `CO1START.csv` - CO1スタート地点
- `CO1GOAL.csv` - CO1ゴール地点

これらを使用して動作確認ができます。

## 🔧 技術仕様

- **言語**: HTML, CSS, JavaScript（純粋なJavaScript、フレームワーク不要）
- **動作環境**: モダンなWebブラウザ（Chrome, Firefox, Edge, Safari）
- **依存関係**: なし（外部ライブラリ不要）
- **ストレージ**: GitHub Repository（GitHub API経由）
- **認証**: Personal Access Token（アップロード・削除に必要）
- **自動更新間隔**: 120秒（2分）- GitHub API制限に配慮

## 📊 GitHub API制限について

### 未認証リクエスト（閲覧のみ）
- **制限**: IPアドレスごとに1時間60リクエスト
- **影響**: 結果公開ページの閲覧は各ユーザー個別にカウント
- **自動更新**: 2分ごと = 30リクエスト/時間（余裕あり）

### 認証済みリクエスト（PAT使用）
- **制限**: トークンごとに1時間5000リクエスト
- **影響**: アップロード・削除・管理画面での操作
- **推奨**: 複数の管理者で同じトークンを共有可能

### 推奨事項
- 結果公開ページは何人が閲覧してもOK（各自が個別制限）
- 自動更新は2分間隔で十分な余裕あり
- 管理操作（アップロード・削除）は5000リクエスト/時間まで可能

## 📝 カスタマイズ

### 自動更新間隔の変更

`config.js` の以下の行を編集：

```javascript
AUTO_REFRESH_INTERVAL: 120000,  // 120秒（2分） → 任意のミリ秒に変更
```

**注意**: 60秒未満にするとGitHub API制限に達する可能性があります。

### CSVディレクトリの変更

管理画面の設定で「CSVディレクトリ」を変更できます。
デフォルトは `csv` ですが、任意のディレクトリ名を設定可能です。
Personal Access Token（PAT）のセキュリティ

- **ブラウザに保存**: PATはブラウザのlocalStorageに保存されます
- **公開リスク**: 公開PCでは使用後にブラウザデータをクリアしてください
- **権限設定**: 必要最小限の権限（repoスコープのみ）を付与してください
- **定期更新**: PATは定期的に再生成することを推奨します

### リポジトリのアクセス制御

- **データリポジトリ**: Privateにすることで部外者からのアクセスを制限可能
- **アプリリポジトリ**:2分ごと（30リクエスト/時間）なので問題ありません
- Personal Access Tokenを使用すれば5000リクエスト/時間に増加

### ブラウザ互換性

- 最新のモダンブラウザを使用してください
- Internet Explorer は非対応です
- モバイルブラウザでも動作しますが、PCでの使用を推奨

## 🔐 セキュリティのベストプラクティス

1. **PATの管理**
   - 絶対に公開リポジトリにコミットしないでください
   - 使用後は必要に応じてブラウザのlocalStorageをクリア

2. **リポジトリ設定**
   - データリポジトリはPrivateを推奨
   - 必要な人にのみコラボレーターとして追加

3. **ファイルの内容**
   - 個人情報や機密情報をCSVに含めないでください
   - ゼッケン番号のみを記録してください

## 🔧 トラブルシューティング

### よくある問題

**Q: 「GitHub設定が完了していません」と表示される**
- A: 管理画面でGitHub設定（ユーザー名、リポジトリ名など）を入力・保存してください

**Q: アップロードできない**
- A: Personal Access Tokenが正しく設定されているか確認してください
- A: トークンに `repo` スコープが付与されているか確認してください

**Q: ファイルが見つからない**
- A: GitHubリポジトリに `csv` ディレクトリが存在するか確認してください
- A: アップロードしたファイルがリポジトリに反映されているか確認してください

**Q: 計算結果が表示されない**
- A: ブラウザのコンソール（F12）でエラーメッセージを確認してください
- A: CSVファイルの形式が正しいか確認してください

**Q: 自動更新が動作しない**
- A: 管理画面で自動計算のチェックボックスがONになっているか確認してください
- A: ブラウザのコンソールでエラーがないか確認してください

**Q: 変更がwebページに反映されない**
- A: プルリクエストをmainブランチにマージする必要があります
- A: マージ後、GitHub Actionsのデプロイ完了（1〜3分）を待ってください
- A: ブラウザのキャッシュをクリア（`Ctrl+Shift+R` / `Cmd+Shift+R`）してください
- 詳細: [DEPLOYMENT.md](DEPLOYMENT.md) を参照

### デバッグ方法

1. ブラウザの開発者ツール（F12）を開く
2. Consoleタブでエラーメッセージを確認
3. NetworkタブでAPIリクエストを確認

## 🚀 デプロイメント

このアプリケーションはGitHub Pagesで自動デプロイされます。

### 変更を公開する手順:
1. mainブランチにマージ（またはプッシュ）
2. GitHub Actionsが自動的にデプロイ（1〜3分）
3. https://ishitatsu0117.github.io/PC-Calculator/ で確認

**詳細なデプロイメントガイド**: [DEPLOYMENT.md](DEPLOYMENT.md) を参照してください。

## 📄 ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 🎯 今後の拡張予定

- [ ] CSV形式のエクスポート機能
- [ ] PDFレポート生成
- [ ] 複数イベントの管理
- [ ] ゼッケンごとの統計情報
- [ ] グラフ表示機能
- [ ] データのフィルタリング・ソート機能

---

**作成日**: 2026年2月  
**バージョン**: 1.0.0  
**ライセンス**: MIT License
